<!DOCTYPE html>
<html lang="zh-CH">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#fffff1"><meta name="generator" content="Hexo 5.4.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#fffff1">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" integrity="sha256-jTIdiMuX/e3DGJUGwl3pKSxuc6YOuqtJYkM0bGQESA4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.likepanda.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.10.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":10,"offset":5},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="介绍反射机制">
<meta property="og:type" content="article">
<meta property="og:title" content="rivia site">
<meta property="og:url" content="http://www.likepanda.cn/2022/03/25/build-vnc/index.html">
<meta property="og:site_name" content="rivia site">
<meta property="og:description" content="介绍反射机制">
<meta property="og:locale" content="zh_CH">
<meta property="og:image" content="http://www.likepanda.cn/build-vnc/fig1.jpg">
<meta property="og:image" content="http://www.likepanda.cn/build-vnc/fig2.jpg">
<meta property="og:image" content="http://www.likepanda.cn/build-vnc/fig3.jpg">
<meta property="og:image" content="http://www.likepanda.cn/build-vnc/fig4.jpg">
<meta property="og:image" content="http://www.likepanda.cn/build-vnc/fig5.jpg">
<meta property="og:image" content="http://www.likepanda.cn/build-vnc/fig6.jpg">
<meta property="og:image" content="http://www.likepanda.cn/build-vnc/fig7.jpg">
<meta property="article:published_time" content="2022-03-25T09:06:08.858Z">
<meta property="article:modified_time" content="2023-03-14T03:00:09.409Z">
<meta property="article:author" content="Jok Brown">
<meta property="article:tag" content="blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.likepanda.cn/build-vnc/fig1.jpg">


<link rel="canonical" href="http://www.likepanda.cn/2022/03/25/build-vnc/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CH","comments":true,"permalink":"http://www.likepanda.cn/2022/03/25/build-vnc/","path":"2022/03/25/build-vnc/","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title> | rivia site</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">rivia site</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">deep thinking</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于rivia</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>博客归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索本站
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%95%85%E4%BA%8B"><span class="nav-number">2.</span> <span class="nav-text">一个简单的故事</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-%E5%85%83%E7%B1%BB"><span class="nav-number">3.</span> <span class="nav-text">C++元类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BE%B3%E9%97%A8%E5%B8%81%E6%A6%82%E8%A7%88"><span class="nav-number">3.1.</span> <span class="nav-text">澳门币概览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B1%BB%E5%9E%8B"><span class="nav-number">3.2.</span> <span class="nav-text">类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7"><span class="nav-number">3.3.</span> <span class="nav-text">属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B1%BB"><span class="nav-number">3.4.</span> <span class="nav-text">类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%80%BC"><span class="nav-number">3.5.</span> <span class="nav-text">值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RealValue"><span class="nav-number">3.6.</span> <span class="nav-text">RealValue</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%80%BC%E5%8F%A5%E6%9F%84"><span class="nav-number">3.7.</span> <span class="nav-text">值句柄</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Object"><span class="nav-number">3.8.</span> <span class="nav-text">Object</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Setting-the-values-for-the-objects"><span class="nav-number">3.8.1.</span> <span class="nav-text">Setting the values for the objects:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Getting-the-values"><span class="nav-number">3.8.2.</span> <span class="nav-text">Getting the values:</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reflection-for-existing-C-classes"><span class="nav-number">4.</span> <span class="nav-text">Reflection for existing C++ classes</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Pointer-to-member"><span class="nav-number">4.1.</span> <span class="nav-text">Pointer to member</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pointer-to-member-Types"><span class="nav-number">4.2.</span> <span class="nav-text">pointer-to-member Types</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#C-%E7%B1%BB"><span class="nav-number">4.3.</span> <span class="nav-text">C++类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#C-%E5%AF%B9%E8%B1%A1"><span class="nav-number">4.4.</span> <span class="nav-text">C++对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%B3%95"><span class="nav-number">4.5.</span> <span class="nav-text">用法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#C-%E6%8E%A5%E5%8F%A3"><span class="nav-number">4.6.</span> <span class="nav-text">C++接口</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Jok Brown</p>
  <div class="site-description" itemprop="description">python c++ qt</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">12</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CH">
    <link itemprop="mainEntityOfPage" href="http://www.likepanda.cn/2022/03/25/build-vnc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jok Brown">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rivia site">
      <meta itemprop="description" content="python c++ qt">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | rivia site">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
        </h1>

        <div class="post-meta-container">
          
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-03-25 17:06:08" itemprop="dateCreated datePublished" datetime="2022-03-25T17:06:08+08:00">2022-03-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-03-14 11:00:09" itemprop="dateModified" datetime="2023-03-14T11:00:09+08:00">2023-03-14</time>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>反射机制</p>
<span id="more"></span>

<p>C++是一种强类型编译器语言。虽然不像ADA那样强类型，但如果您尝试将一种类型的对象分配给另一种类型的对象（如果没有可接受的转换），则C++编译器会抱怨。显然，这要求编译器知道所有可用的类型。更具体地说，所有类都必须在编译时<a target="_blank" rel="noopener" href="http://www.vollmann.com/en/pubs/meta/meta/meta.html#fn1">知道1</a>。但有时，在运行时添加新类会非常方便。在某些应用领域，这是绝对必要的。</p>
<h2 id="一个简单的故事"><a href="#一个简单的故事" class="headerlink" title="一个简单的故事"></a>一个简单的故事</h2><p>让我们看一个简单的例子：苏珊，当地一家书店的经理，想扩展到互联网。所以她要求你为一家互联网书店写一个简单的程序。对你来说没问题。解决方案的一部分可能类似于图 1 中的类模型。<br><img src="/build-vnc/fig1.jpg" alt="Fig. 1: Simple Shop Model"><br>图 1：简单车间模型</p>
<p>C++中实现它非常简单。这是课程：<br>你的解决方案有效，苏珊很高兴，一切都很好……<br>但互联网时代，网络上发生了变化：书店取得了成功，苏珊也决定出售CD。所以你必须改变你的程序。使用面向对象，您可以非常轻松地执行此操作，并且您修改后的类模型将如图 2 所示。<br><img src="/build-vnc/fig2.jpg" alt="Fig. 2: Product Model"><br>图2：产品模型</p>
<p>您可能已经猜到了，这仅仅是个开始。一段时间后，苏珊也想卖流行音乐配件，如T恤，海报等。<br>现在很明显，每次引入新产品类别时修改程序的源代码都是不可接受的。因此，您开始考虑实际需求，并发现需要为类提供不同的接口（图 3）：用于提供 、 和 的简单接口。这是你已经拥有的。然后，您需要为常规搜索机<a target="_blank" rel="noopener" href="http://www.vollmann.com/en/pubs/meta/meta/meta.html#fn2">2</a>设置一个不同的界面，该界面必须提供以下信息：<code>Book</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">class</span> <span class="title">Book</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        Book(<span class="keyword">const</span> <span class="built_in">string</span> &amp; author_,</span><br><span class="line">             <span class="keyword">const</span> <span class="built_in">string</span> &amp; title_,</span><br><span class="line">             <span class="keyword">const</span> <span class="built_in">string</span> &amp; publisher_,</span><br><span class="line">             <span class="built_in">double</span> price_,</span><br><span class="line">             <span class="built_in">double</span> weight_);</span><br><span class="line">        <span class="function"><span class="built_in">string</span> <span class="title">getName</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> name;</span><br><span class="line">            name = author + <span class="string">&quot;: &quot;</span> + title;</span><br><span class="line">            <span class="keyword">return</span> name.substr(<span class="number">0</span>, <span class="number">40</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="built_in">double</span> <span class="title">getPrice</span>()</span>;</span><br><span class="line">        <span class="function"><span class="built_in">double</span> <span class="title">getWeight</span>()</span>;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="built_in">string</span> author, title, publisher;</span><br><span class="line">        <span class="built_in">double</span> price, weight;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">Product``ShoppingCart``getName()``getPrice()``getWeight()</span><br></pre></td></tr></table></figure>

<ul>
<li>对象的实际类是什么</li>
<li>该类具有哪些属性</li>
<li>对象的这些属性的实际值是什么。</li>
</ul>
<p>这是一个经典的反射接口，为您提供有关类和对象属性的信息。<br>但是，您还需要第三个用于产品维护的接口，该接口允许您定义新的产品类、为它们指定属性、创建这些类的实例以及设置这些实例的属性值。这样的接口被称为“元对象协议（MOP）”，并在[<a target="_blank" rel="noopener" href="http://www.vollmann.com/en/pubs/meta/meta/meta.html#bk1">1</a>]中进行了详尽的讨论。反射协议是此类 MOP 的子集。<br><img src="/build-vnc/fig3.jpg" alt="Fig. 3: A Better Model"><br>图 3：更好的模型</p>
<h2 id="C-元类"><a href="#C-元类" class="headerlink" title="C++元类"></a>C++元类</h2><p>“元对象协议”是什么意思？嗯，元信息是关于从一个超越的层次看到的其他东西的信息—— 一个元层次。因此，有关对象属性值的信息（例如 ）是对象级别的信息。但是，有关对象本身的属性、属性、结构等的信息是元信息。<br>在C++中，此信息在对象的类定义中捕获，因此该类是元对象。在C++中，您在课堂上拥有MOP的所有功能 - 这是在开发时。但是该级别在运行时不可用：您不能像对象一样操作类，也不能在运行时添加新类。MOP的想法是折叠元级别（类）和对象级别（对象）;即使类定义成为普通对象，并且对象属性是可以在运行时操作的类定义的正常属性值。<br>虽然像CLOS或Smalltalk这样的语言直接提供了这种组合级别，但C++强类型编译器语言没有这样的功能。那么，你能做些什么呢？典型的解决方案是自己提供MOP，例如在[2]或[<a target="_blank" rel="noopener" href="http://www.vollmann.com/en/pubs/meta/meta/meta.html#bk3">3</a>]中提出的。<code>someBook.author</code></p>
<h3 id="澳门币概览"><a href="#澳门币概览" class="headerlink" title="澳门币概览"></a>澳门币概览</h3><p>为简单起见，我们现在忽略方法，因此我们的 MOP 必须提供：</p>
<ul>
<li>新类的定义</li>
<li>向类添加属性</li>
<li>查询类的属性</li>
<li>创建对象</li>
<li>查询对象的类</li>
<li>设置对象的属性值</li>
<li>查询对象的属性值</li>
<li>删除对象</li>
</ul>
<p>如果你使用OO设计的旧规则，你把上述要求的所有名词都拿出来，从中生成类。当您考虑“属性”和“值”时，您必须确定它们是否被键入。由于键入了基础语言C++，因此应在设计中反映这一点。<br>另一个问题是关于继承支持。对于我们关于互联网商店和产品层次结构的示例，这可能非常有用。因此，第一类模型如图 4 所示。<br><img src="/build-vnc/fig4.jpg" alt="Fig. 4: MOP Class Model"><br>图 4： MOP 类模型</p>
<h3 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h3><p>虽然自上而下地进行一般概述很有用，但从细节的简单基本内容开始会更容易。因此，我们首先看一下 .<br>主要目的是区分不同类型的s。为此，一个简单的就足够了。但是类型的想法是为不同的s提供不同的种类，所以应该创建新的s。因此，我们将类放入内部，提供方法，并获取图 4 中所示的接口。<br>现在实施。虽然我们现在不仔细研究，但如果我们有不同类型的值，我们可能需要一些基类。让我们将其称为 “”，并且只能返回指向 的指针。<br>现在我们知道要创造什么，但如何创造呢？虽然有几种模式可以实现多态创建[<a target="_blank" rel="noopener" href="http://www.vollmann.com/en/pubs/meta/meta/meta.html#bk4">4</a>]，但就我们的目的而言，最简单的模式可能是原型，它可以通过简单的<a target="_blank" rel="noopener" href="http://www.vollmann.com/en/pubs/meta/meta/meta.html#fn3">3</a>轻松实现。<br>现在，我们已拥有实现整个类的所有内容：<code>Type``Type``Attribute``enum``Values``Type``Type``Value``enum``Type``newValue()``Value``BaseValue``newValue()``BaseValue``static vector</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Type</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">TypeT</span> &#123;stringT, intT, doubleT, unknownT&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Type</span><span class="params">(TypeT typeId_)</span> : typeId(typeId_) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">BaseValue * <span class="title">newValue</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> prototypes[typeId]-&gt;<span class="built_in">clone</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">TypeT <span class="title">getType</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> typeId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">init</span><span class="params">()</span></span>;</span><br><span class="line">    &#123;</span><br><span class="line">        prototypes[stringT] = <span class="keyword">new</span> <span class="built_in">Value</span>&lt;string&gt;(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        prototypes[intT] = <span class="keyword">new</span> <span class="built_in">Value</span>&lt;<span class="type">int</span>&gt;(<span class="number">0</span>);</span><br><span class="line">        prototypes[doubleT] = <span class="keyword">new</span> <span class="built_in">Value</span>&lt;<span class="type">double</span>&gt;(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    TypeT typeId;</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> vector&lt;BaseValue *&gt; prototypes;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;BaseValue *&gt; <span class="title">Type::prototypes</span><span class="params">(Type::unknownT)</span></span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h3><p>由于我们决定通过 创建新的 s，因此只包含名称和类型，因此下面是其实现：<code>Value``Type``Attribute</code></p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Attribute</span><br><span class="line">&#123;</span><br><span class="line">public:</span><br><span class="line">    <span class="constructor">Attribute(<span class="params">const</span> <span class="params">string</span> &amp; <span class="params">name_</span>, Type::TypeT <span class="params">typeId</span>)</span></span><br><span class="line">     : name(name_), <span class="keyword">type</span><span class="constructor">_(<span class="params">typeId</span>)</span></span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    const <span class="built_in">string</span> &amp; get<span class="constructor">Name()</span> const</span><br><span class="line">    &#123;</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line">    Type get<span class="constructor">Type()</span> const</span><br><span class="line">    &#123;</span><br><span class="line">        return type_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">string</span> name;</span><br><span class="line">    Type type_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="类"><a href="#类" class="headerlink" title="类"></a>类</h3><p>现在，我们可以通过查看自身来完成模型的类（元）级别。由于多重继承可能不是我们的目的的问题，因此我们只有一个指向基类的指针（可以是0）。更重要的问题是属性列表：它应该只包含为此类定义的属性，还是应该包括所有继承的属性？虽然对于实际的对象值访问，完整列表更有用（而且速度更快），但对于类维护，了解在哪个类中定义了哪个属性可能很重要。所以我们只保留两者。对于完整列表，顺序可能很重要：应该先是自己的属性还是继承的属性？在大多数插图中，继承的属性排在第一位，因此我们也保持此顺序。<br>如果属性的名称与继承属性的名称相同，会发生什么情况？由于C++允许它，我们也可以允许它（为我们节省了一些额外的检查工作），但是在这种情况下，我们必须保证在按名称查找属性时，我们会得到派生最多的属性。所以，必须做一个反向搜索。我们该从什么回来？STL 方法是返回迭代器，但对于具有 GUI 的应用程序（创建新对象并根据选择列表为其属性赋值），对属性进行基于索引的访问将更合适。因此，返回一个索引并获取一个索引并返回一个 .因此，列表必须是索引容器，因此我们为它们选择 s。<br>的一个主要目的是从中创建 s，因此它有一个返回指向 的指针的方法。我们是否需要保留一个引用所有已创建对象的存储库？对于完整的反射接口，我们应该这样做。但对于实际应用程序，这几乎从来都没用，因为同一类的对象是为完全不同的目的而创建的。但是，我们是否需要存储库供内部使用？这取决于我们在创建对象后要对对象执行的操作。这直接导致了另一个重要的决定：如果我们向类添加新属性，我们如何处理已经存在的对象？一种选择是将此属性添加到所有现有对象并为其分配默认值。另一种选择是保留这些现有对象，并仅将 new 属性添加到新对象。这导致同一类的对象同时具有不同的结构，然后我们必须向对象添加一些版本信息。但是还有第三种选择：一旦创建了类的实例，就禁止修改该类定义。这是最简单的选项，因此我们将其用于MOP并添加标志 。有了这个标志，我们可以跳过对象存储库。<br>最后一个设计问题是何时添加属性：在类定义的创建时（通过构造函数）还是稍后（使用成员函数）？对于不同的应用程序，这两个选项可能都很有用，因此我们将提供两个构造函数和 。<br>现在，您可以实现此 <a target="_blank" rel="noopener" href="http://www.vollmann.com/en/pubs/meta/meta/meta.html#fn4">4</a>：<code>Class``findAttribute()``findAttribute()``findAttribute()``getAttribute()``Attribute``Attribute``vector``Class``Object``newObject()``Object``definitionFix``addAttribute()</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ClassDef</span></span><br><span class="line">&#123;        <span class="comment">//typedefs Container, Iterator for attributes</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ClassDef</span>(ClassDef <span class="type">const</span> * base, <span class="type">const</span> string &amp; name_)</span><br><span class="line">     : <span class="built_in">baseClass</span>(base), <span class="built_in">name</span>(name_),</span><br><span class="line">       <span class="built_in">definitionFix</span>(<span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">baseInit</span>();</span><br><span class="line">        effectiveAttributes.<span class="built_in">insert</span>(effectiveAttributes.<span class="built_in">end</span>(),</span><br><span class="line">                                   ownAttributes.<span class="built_in">begin</span>(),</span><br><span class="line">                                   ownAttributes.<span class="built_in">end</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> iterator&gt;</span><br><span class="line">    <span class="built_in">ClassDef</span>(ClassDef <span class="type">const</span> * base, <span class="type">const</span> string &amp; name_,</span><br><span class="line">             iterator attribBegin, iterator attribEnd)</span><br><span class="line">     : <span class="built_in">baseClass</span>(base), <span class="built_in">name</span>(name_),</span><br><span class="line">       <span class="built_in">ownAttributes</span>(attribBegin, attribEnd),</span><br><span class="line">       <span class="built_in">definitionFix</span>(<span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">baseInit</span>();</span><br><span class="line">        effectiveAttributes.<span class="built_in">insert</span>(effectiveAttributes.<span class="built_in">end</span>(),</span><br><span class="line">                                   ownAttributes.<span class="built_in">begin</span>(),</span><br><span class="line">                                   ownAttributes.<span class="built_in">end</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">string <span class="title">getName</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">Object * <span class="title">newObject</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        definitionFix = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Object</span>(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">AttrIterator <span class="title">attribBegin</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">AttrIterator <span class="title">attribEnd</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">Attribute <span class="type">const</span> &amp; <span class="title">getAttribute</span><span class="params">(<span class="type">size_t</span> idx)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addAttribute</span><span class="params">(<span class="type">const</span> Attribute &amp;)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">getAttributeCount</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">findAttribute</span><span class="params">(string <span class="type">const</span> &amp; name)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// this does a reverse search to find the most derived</span></span><br><span class="line">        AttributeContainer::const_reverse_iterator i;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = effectiveAttributes.<span class="built_in">rbegin</span>();</span><br><span class="line">             i != effectiveAttributes.<span class="built_in">rend</span>();</span><br><span class="line">             ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i-&gt;<span class="built_in">getName</span>() == name)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">distance</span>(i, effectiveAttributes.<span class="built_in">rend</span>()) - <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">getAttributeCount</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">baseInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (baseClass)</span><br><span class="line">        &#123;</span><br><span class="line">            baseClass-&gt;definitionFix = <span class="literal">true</span>;</span><br><span class="line">            <span class="built_in">copy</span>(baseClass-&gt;<span class="built_in">attribBegin</span>(), baseClass-&gt;<span class="built_in">attribEnd</span>(),</span><br><span class="line">                 <span class="built_in">back_inserter</span>&lt;AttributeContainer&gt;(effectiveAttributes));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ClassDef <span class="type">const</span> * <span class="type">const</span> baseClass;</span><br><span class="line">    string name;</span><br><span class="line">    AttributeContainer ownAttributes, effectiveAttributes;</span><br><span class="line">    <span class="keyword">mutable</span> <span class="type">bool</span> definitionFix;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="值"><a href="#值" class="headerlink" title="值"></a>值</h3><p><img src="/build-vnc/fig5.jpg" alt="Fig. 5: Value Model"><br>图5：价值模型<br>在设计之前，我们必须考虑。我们需要一个通用的界面来管理它们，我们已经称之为 。但是我们需要什么接口呢？整个想法是存储值，因此我们需要一个函数。什么参数？我们唯一拥有的是 ，所以这就是参数类型。按值、按引用或按指针传递？绝对不是按值，因为只是一个接口。另一方面，您传递的是一个值，因此传递的参数应按值传递，以便传递临时参数。因此，一种选择是通过 const 引用传递。但是，尽管这有助于解决手头的问题，但它并不能解决根本问题：你应该有一个值，但你所拥有的只是一个多态接口。这里真正的解决方案是pimpl成语，也称为柴郡猫，信封/信件，或更一般的手柄/身体。因此，我们添加一个句柄类，为其命名，稍后再看一遍。目前，我们仍然处于 .<br>我们现在有，那又如何呢？的返回类型是 ，实现将如下所示：<br>但是我们可以直接执行，因此没有多大意义。<br>我们还需要哪些其他功能？必须复制值，因此我们添加了 .<br>这就是我们真正需要的值，但我们添加是为了方便<a target="_blank" rel="noopener" href="http://www.vollmann.com/en/pubs/meta/meta/meta.html#fn5">5</a>。<code>Object``Value``BaseValue``Value``set()``BaseValue``BaseValue``Value``BaseValue``set(Value)``get()``get()``Value</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function">Value <span class="title">BaseValue::get</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>; <span class="comment">// calls Value(BaseValue const &amp;)</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="built_in">get</span>()``BaseValue``<span class="built_in">clone</span>()``<span class="built_in">asString</span>()</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">BaseValue</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="keyword">virtual</span> ~<span class="built_in">BaseValue</span>()&#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> BaseValue * <span class="title">clone</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> string <span class="title">asString</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// fromString()</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">set</span><span class="params">(Value <span class="type">const</span> &amp; v)</span> </span>= <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// no get()!</span></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="comment">// Type info</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<h3 id="RealValue"><a href="#RealValue" class="headerlink" title="RealValue"></a>RealValue</h3><p>现在，由于我们有了接口，那么实现呢？我们需要 、 . … 的值。并且一个值必须包含 一个 ， 一个值 a ，等等。这看起来像是模板的机会。因此，让我们定义，从中派生它，实现继承的接口，我们几乎完成了。但是，由于只是一个带有一些附加功能的包装器，但本质上仍然是一个，我们应该通过提供转换构造函数和转换运算符来提供双向转换。<br>注意：由于我们在两个方向上都有转换，我们可以使用类似：<br>几乎：以下不起作用：<br>原因是编译器只应用一个用户定义的转换，但对于字符串文本，您需要两个：from to ，和 from to to 。如果要在 MOP 外部使用，则应定义一个特化：注意：<br>实际上，从 派生并不是很干净，但只要您不删除指向 的指针，它就会起作用。<code>int``double``string``int``int``double``double``RealValue``BaseValue``RealValue``T``T</code></p>
<figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">template</span> &lt;typename PlainT&gt;</span><br><span class="line">    <span class="keyword">class</span> RealValue : <span class="keyword">public</span> BaseValue</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        RealValue(PlainT v)</span><br><span class="line">         : val(v) &#123;&#125;</span><br><span class="line"></span><br><span class="line">        RealValue * clone() <span class="keyword">const</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> RealValue(*<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">string</span> asString() <span class="keyword">const</span></span><br><span class="line">        &#123;</span><br><span class="line">            ostringstream os;</span><br><span class="line">            os &lt;&lt; val;</span><br><span class="line">            <span class="keyword">return</span> os.str();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        operator PlainT() <span class="keyword">const</span> <span class="comment">// conversion to plain type</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> val;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        RealValue&lt;PlainT&gt;::set(Value <span class="keyword">const</span> &amp; v)</span><br><span class="line">        &#123;</span><br><span class="line">            val = v.get&lt;PlainT&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        PlainT val;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">RealValue<span class="string">``</span>RealValue<span class="string">``</span>T</span><br><span class="line">    RealValue&lt;<span class="keyword">int</span>&gt; i = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> j = i;</span><br><span class="line">    RealValue&lt;<span class="built_in">double</span>&gt; d = i + <span class="number">5.2</span> / (i*<span class="number">2</span>);</span><br><span class="line">    cout &lt;&lt; d &lt;&lt; endl;</span><br><span class="line">    </span><br><span class="line">    RealValue&lt;<span class="built_in">string</span>&gt; name, author = <span class="string">&quot;Bjarne&quot;</span>, title = <span class="string">&quot;The C++ PL&quot;</span>;</span><br><span class="line">    name = author + <span class="string">&quot;: &quot;</span> + title;</span><br><span class="line">    cout &lt;&lt; name &lt;&lt; endl;</span><br><span class="line">    </span><br><span class="line"><span class="built_in">char</span> <span class="keyword">const</span> *<span class="string">``</span><span class="built_in">string</span><span class="string">``</span><span class="built_in">string</span><span class="string">``</span>RealValue<span class="string">``</span>RealValue</span><br><span class="line">    <span class="keyword">template</span> &lt;&gt;</span><br><span class="line">    <span class="keyword">class</span> RealValue&lt;<span class="built_in">string</span>&gt; : <span class="keyword">public</span> BaseValue, <span class="keyword">public</span> <span class="built_in">string</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        RealValue(<span class="built_in">string</span> <span class="keyword">const</span> &amp; s) : <span class="built_in">string</span>(s) &#123;&#125;</span><br><span class="line">        RealValue(<span class="built_in">char</span> <span class="keyword">const</span> * s) : <span class="built_in">string</span>(s) &#123;&#125;</span><br><span class="line">        RealValue() &#123;&#125;</span><br><span class="line"></span><br><span class="line">        RealValue * clone() <span class="keyword">const</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> RealValue(*<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">string</span> asString() <span class="keyword">const</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> static_cast&lt;<span class="built_in">string</span>&gt;(*<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// no operator string(), conversion to base automatically</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">void</span> set(Value <span class="keyword">const</span> &amp; v)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span>::operator=(v.get&lt;<span class="built_in">string</span>&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">RealValue<span class="string">``</span>std::<span class="built_in">string</span><span class="string">``</span>RealValue<span class="string">``</span><span class="built_in">string</span></span><br></pre></td></tr></table></figure>

<h3 id="值句柄"><a href="#值句柄" class="headerlink" title="值句柄"></a>值句柄</h3><p>现在回到句柄类。作为句柄类，它包含其主体并照顾它。其主要工作是采用/创建和删除其正文。它镜像正文的界面并转发所有消息。但它也应该是一个真正的值类，从而提供默认和复制构造函数和赋值。但是如何实现默认构造函数呢？由于我们不知道要创建什么类型，因此我们必须创建一个没有正文的空句柄，并在转发之前检查我们是否真的有要转发的内容。赋值本质上是 ，因此我们跳过 .<br>现在让我们回到.当然，返回或没有意义。但是，返回甚至包装的基础值呢？这将是非常有用的，但为此，我们必须告诉我们我们想要的返回类型。因此，成为成员模板，因此可以返回 .<code>Value``set()``set()``get()``Value``BaseValue``RealValue``get()``get()``RealValue&lt;&gt;</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Value</span>        <span class="comment">// Value handle</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Value</span>(BaseValue <span class="type">const</span> &amp; bv)</span><br><span class="line">     : <span class="built_in">v</span>(bv.<span class="built_in">clone</span>())</span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Value</span>(Value <span class="type">const</span> &amp; rhs)</span><br><span class="line">     : <span class="built_in">v</span>(rhs.v ? rhs.v-&gt;<span class="built_in">clone</span>() : <span class="number">0</span>)</span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Value</span><span class="params">(BaseValue * bv = <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function">     : v(bv)</span></span><br><span class="line"><span class="function">    &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">Value</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">delete</span> v;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Value &amp; <span class="keyword">operator</span>=(<span class="type">const</span> Value &amp; rhs)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// this is not a typical pimpl assignment, but a set()</span></span><br><span class="line">        <span class="keyword">if</span> (v)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (rhs.v)</span><br><span class="line">            &#123; <span class="comment">// fine, all v&#x27;s exist</span></span><br><span class="line">                v-&gt;<span class="built_in">set</span>(rhs);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123; <span class="comment">// the other v doesn&#x27;t exist, so we must delete our own :-(</span></span><br><span class="line">                BaseValue * old = v;</span><br><span class="line">                v = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">delete</span> old;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123; <span class="comment">// we don&#x27;t have a v, so just copy the other</span></span><br><span class="line">            v = (rhs.v ? rhs.v-&gt;<span class="built_in">clone</span>() : <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> PlainT&gt;</span><br><span class="line">    <span class="function">PlainT <span class="title">get</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (v)</span><br><span class="line">        &#123;</span><br><span class="line">            RealValue&lt;PlainT&gt; <span class="type">const</span> &amp; rv</span><br><span class="line">                = <span class="keyword">dynamic_cast</span>&lt;RealValue&lt;PlainT&gt; <span class="type">const</span> &amp;&gt;(*v);</span><br><span class="line">            <span class="keyword">return</span> rv;        <span class="comment">// uses conversion operator</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">PlainT</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::string <span class="title">asString</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (v)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> v-&gt;<span class="built_in">asString</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">string</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    BaseValue * v;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h3><p>Finally we come to . Now, as we have everything else, an is mainly a container for its attribute values. To ease implementation, we will structurally mirror the attribute container in the class definition, so we use a . As we have so much effort invested in our handle, it would make sense to store that in the . But for future extensions it will be easier to have the pointers directly available.<br>The constructor will create the values through the types of the attributes, so the only constructor takes a .<br>To set and get the values for the attributes, we provide two options: to specify the attribute by name and also by index.<br>For reflection purposes (as well as for internal implementation) we need a pointer to the class definition, but then we have it all:<br>Now the MOP is complete. Let’s use it:<br>Creating the class:<br>Adding attributes:<br>Creating the class with an attribute list:<br>Creating an object:<code>Object``Object``vector``Value``vector``BaseValue``ClassDef*</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">class</span> <span class="title class_">Object</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">explicit</span> <span class="title">Object</span><span class="params">(ClassDef <span class="type">const</span> * class_)</span></span></span><br><span class="line"><span class="function">         : myClass(class_), values(class_-&gt;getAttributeCount())</span></span><br><span class="line"><span class="function">        &#123;</span></span><br><span class="line">            <span class="built_in">buildValueList</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">ClassDef <span class="type">const</span> &amp; <span class="title">instanceOf</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> *myClass;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">Value <span class="title">getValue</span><span class="params">(<span class="type">size_t</span> attribIdx)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> *values[attribIdx]; <span class="comment">// calls Value(BaseValue &amp;)</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function">Value <span class="title">getValue</span><span class="params">(string <span class="type">const</span> &amp; attribName)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="type">size_t</span> idx = <span class="built_in">instanceOf</span>()-&gt;<span class="built_in">findAttribute</span>(attribName);</span><br><span class="line">            <span class="comment">// should check for not found</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">getValue</span>(idx);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">setValue</span><span class="params">(<span class="type">size_t</span> idx, Value <span class="type">const</span> &amp; v)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            values[idx]-&gt;<span class="built_in">set</span>(v);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">setValue</span><span class="params">(string <span class="type">const</span> &amp; attribName, Value <span class="type">const</span> &amp;v)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="type">size_t</span> idx = <span class="built_in">instanceOf</span>()-&gt;<span class="built_in">findAttribute</span>(attribName);</span><br><span class="line">            <span class="comment">// should check for not found</span></span><br><span class="line">            <span class="built_in">setValue</span>(idx, v);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="keyword">typedef</span> vector&lt;BaseValue *&gt; ValueContainer;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">buildValueList</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            ClassDef::AttrIterator a;</span><br><span class="line">            ValueContainer::iterator i = values.<span class="built_in">begin</span>();</span><br><span class="line">            <span class="keyword">for</span> (a = <span class="built_in">instanceOf</span>()-&gt;<span class="built_in">attribBegin</span>();</span><br><span class="line">                 a != <span class="built_in">instanceOf</span>()-&gt;<span class="built_in">attribEnd</span>();</span><br><span class="line">                 ++a, ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                *i = a-&gt;<span class="built_in">getType</span>().<span class="built_in">newValue</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ClassDef <span class="type">const</span> * <span class="type">const</span> myClass;</span><br><span class="line">        ValueContainer values;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">Product</span><br><span class="line">    ClassDef * product</span><br><span class="line">         = <span class="keyword">new</span> <span class="built_in">ClassDef</span>(<span class="number">0</span>, <span class="comment">// no base class for Product</span></span><br><span class="line">                        <span class="string">&quot;Product&quot;</span>); <span class="comment">// name of class</span></span><br><span class="line">    </span><br><span class="line">    product-&gt;<span class="built_in">addAttribute</span>(<span class="built_in">Attribute</span>(<span class="string">&quot;Product Number&quot;</span>, Type::intT));</span><br><span class="line">    product-&gt;<span class="built_in">addAttribute</span>(<span class="built_in">Attribute</span>(<span class="string">&quot;Name&quot;</span>, Type::stringT));</span><br><span class="line">    product-&gt;<span class="built_in">addAttribute</span>(<span class="built_in">Attribute</span>(<span class="string">&quot;Price&quot;</span>, Type::doubleT));</span><br><span class="line">    product-&gt;<span class="built_in">addAttribute</span>(<span class="built_in">Attribute</span>(<span class="string">&quot;Weight&quot;</span>, Type::doubleT));</span><br><span class="line">    </span><br><span class="line">Book</span><br><span class="line">    list&lt;Attribute&gt; attrL;</span><br><span class="line">    attrL.<span class="built_in">push_back</span>(<span class="built_in">Attribute</span>(<span class="string">&quot;Author&quot;</span>, Type::stringT));</span><br><span class="line">    attrL.<span class="built_in">push_back</span>(<span class="built_in">Attribute</span>(<span class="string">&quot;Title&quot;</span>, Type::stringT));</span><br><span class="line">    attrL.<span class="built_in">push_back</span>(<span class="built_in">Attribute</span>(<span class="string">&quot;ISBN&quot;</span>, Type::intT));</span><br><span class="line"></span><br><span class="line">    ClassDef * book</span><br><span class="line">     = <span class="keyword">new</span> <span class="built_in">ClassDef</span>(product, <span class="comment">// base class</span></span><br><span class="line">                    <span class="string">&quot;Book&quot;</span>,</span><br><span class="line">                    attrL.<span class="built_in">begin</span>(), attrL.<span class="built_in">end</span>());</span><br><span class="line">    </span><br></pre></td></tr></table></figure>



<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="class">Object</span></span> * <span class="function"><span class="title">bscpp</span>(<span class="variable">book</span>-&gt;<span class="title">newObject</span>());</span></span><br><span class="line"><span class="function"></span></span><br></pre></td></tr></table></figure>

<h4 id="Setting-the-values-for-the-objects"><a href="#Setting-the-values-for-the-objects" class="headerlink" title="Setting the values for the objects:"></a>Setting the values for the objects:</h4><p>Set an int value by index (don’t forget that index 0 is ):<br>Same for a string value:<br>Better way: set value by name this gives the most derived attribute:<code>ProductNo</code></p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bscpp-&gt;setValue(<span class="number">0</span>, RealValue&lt;int&gt;(<span class="number">12345</span>))<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">bscpp-&gt;setValue(<span class="number">4</span>, RealValue&lt;string&gt;(<span class="string">&quot;Bjarne Stroustrup&quot;</span>))<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bscpp-&gt;setValue(<span class="string">&quot;Title&quot;</span>,</span><br><span class="line">                RealValue&lt;string&gt;(<span class="string">&quot;The C++ Programming Language&quot;</span>))<span class="comment">;</span></span><br><span class="line">bscpp-&gt;setValue(<span class="string">&quot;Weight&quot;</span>, Value&lt;double&gt;(<span class="number">370</span>))<span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Getting-the-values"><a href="#Getting-the-values" class="headerlink" title="Getting the values:"></a>Getting the values:</h4><p>Display a book:<br>and we get:<br>So, our MOP is complete. For our sample application, you have to add a class repository, some nice GUI to define classes and objects, creating the index for the search machine, provide an interface for , but then you’re done, and Susan is happy as she now can create her own new product categories at runtime.</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">        ClassDef::AttrIterator a;</span><br><span class="line">        <span class="attribute">size_t idx;</span></span><br><span class="line"><span class="attribute">        for (a = book-&gt;attribBegin(), idx = 0;</span></span><br><span class="line"><span class="attribute">             a != book-&gt;attribEnd();</span></span><br><span class="line"><span class="attribute">             ++a, ++idx)</span></span><br><span class="line"><span class="attribute">        &#123;</span></span><br><span class="line"><span class="attribute">            cout &lt;&lt; a-&gt;getName() &lt;&lt; &quot;</span><span class="punctuation">:</span> <span class="string">&quot;</span></span><br><span class="line">                 <span class="attribute">&lt;&lt; bscpp-&gt;getValue(idx).asString() &lt;&lt; endl;</span></span><br><span class="line"><span class="attribute">        &#125;</span></span><br><span class="line"><span class="attribute">    </span></span><br><span class="line"><span class="attribute">    Product Number</span><span class="punctuation">:</span> <span class="string">12345</span></span><br><span class="line">    <span class="attribute">Name</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">Price</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">Weight</span><span class="punctuation">:</span> <span class="string">370</span></span><br><span class="line">    <span class="attribute">Author</span><span class="punctuation">:</span> <span class="string">Bjarne Stroustrup</span></span><br><span class="line">    <span class="attribute">Title</span><span class="punctuation">:</span> <span class="string">The C++ Programming Language</span></span><br><span class="line">    <span class="attribute">ISBN</span><span class="punctuation">:</span></span><br><span class="line"><span class="punctuation">    </span></span><br><span class="line">ShoppingCart</span><br></pre></td></tr></table></figure>

<h2 id="Reflection-for-existing-C-classes"><a href="#Reflection-for-existing-C-classes" class="headerlink" title="Reflection for existing C++ classes"></a>Reflection for existing C++ classes</h2><p>If you provide the interface for the in our example, you’ll find that it isn’t so easy. If all classes are dynamic classes, all access must go through the MOP:<br>A for :<br>For a lot of applications, it would be useful to provide some classes of a hierarchy as C++ classes, e.g. , but still let the user add classes of the same hierarchy at runtime, e.g. . So, let’s look at this. If we want access through our MOP to C++ classes, we need a to which we can give the attribute we want to access at runtime. So, here it is:<br>The magic lies in : This is the pointer-to-member selector of C++.<code>ShoppingCart``getName()``Book</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">    <span class="built_in">string</span> <span class="title function_">bookGetName</span>(<span class="params"><span class="built_in">Object</span> <span class="keyword">const</span> * book</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (book-&gt;<span class="title function_">instanceOf</span>().<span class="title function_">getName</span>() != <span class="string">&quot;Book&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* throw some exception */</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">string</span> name;</span><br><span class="line">        <span class="comment">//  name = book-&gt;author + &quot;: &quot; + book-&gt;title;  it was so easy...</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">string</span> author = book-&gt;<span class="title function_">getValue</span>(<span class="string">&quot;Author&quot;</span>).<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">        <span class="built_in">string</span> title = book-&gt;<span class="title function_">getValue</span>(<span class="string">&quot;Title&quot;</span>).<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">        name = author + <span class="string">&quot;: &quot;</span> + title;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> name.<span class="title function_">substr</span>(<span class="number">0</span>, <span class="number">40</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="title class_">Product</span><span class="string">``</span><span class="title class_">TShirt</span><span class="string">``</span><span class="title function_">getValue</span>()</span><br><span class="line">    <span class="title class_">Value</span> <span class="title function_">getValue</span>(<span class="params"><span class="built_in">Object</span> *o, MemberPointer mp</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> o-&gt;*mp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="string">&#x27;-&gt;*&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="Pointer-to-member"><a href="#Pointer-to-member" class="headerlink" title="Pointer to member"></a>Pointer to member</h3><p>You can imaging a pointer-to-member in C++ as an offset<a target="_blank" rel="noopener" href="http://www.vollmann.com/en/pubs/meta/meta/meta.html#fn6">6</a> from the base address of an object to a specific member. If you apply that offset to such a base address, you get a reference to the member (Fig. 6). But as a pointer-to-member is a normal data type in C++, you can store them in containers, pass them to functions, etc. Thus, you can write the function above, building the fundamental base for our combination of C++-classes and runtime-classes.<br><img src="/build-vnc/fig6.jpg" alt="Fig. 6: Pointer to Member"><br>Fig. 6: Pointer to Member<br>Let’s look at some details of pointer-to-members. As an example, we use the following class:<br>A pointer-to-member is a type that is derived from two other types: The type of the base object ( in our example) and the type of the member (). The type decorator for a pointer-to-member is ‘’, so let’s define two variables with initialization:</p>
<p>The pointer-to-member selector comes in two variations: as ‘’ you can apply it to references of the class and as ‘’ it takes a pointer. It is a binary operand, as left operand it takes a reference (or pointer) to an object and as right operand a pointer-to-member. So, with the above definitions, you can do things like<br>Of course, as is a private member of , the assignment of the pointer-to-member must be at the scope of that class. But the pointer-to-members themselves can be used even if you don’t have access privileges to the members (as long as you have access to the pointer-to-member).</p>
<figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">class</span> Product</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">        RealValue&lt;<span class="built_in">double</span>&gt; price;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> Book : <span class="keyword">public</span> Product</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        RealValue&lt;<span class="built_in">string</span>&gt; author, title;</span><br><span class="line">        RealValue&lt;<span class="built_in">double</span>&gt; weight;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    Book b, *bp;</span><br><span class="line">    </span><br><span class="line">Book<span class="string">``</span>RealValue&lt;&gt;<span class="string">``</span>::*<span class="string">``</span>RealValue Book::* bookStringMemPtr = &amp;Book::author;<span class="string">``</span>RealValue Book::* bookDoubleMemPtr = &amp;Book::weight;<span class="string">``</span>.*<span class="string">``</span>-&gt;*</span><br><span class="line">    b.*bookStringMemPtr = <span class="string">&quot;Bjarne Stroustrup&quot;</span>; <span class="comment">// assigns b.author</span></span><br><span class="line"></span><br><span class="line">    bookStringMemPtr = &amp;Book::title;</span><br><span class="line"></span><br><span class="line">    bp-&gt;*bookStringMemPtr = <span class="string">&quot;The C++ Programming Language&quot;</span>; <span class="comment">// assigns b.author</span></span><br><span class="line">    </span><br><span class="line">title<span class="string">``</span>Book</span><br></pre></td></tr></table></figure>

<h3 id="pointer-to-member-Types"><a href="#pointer-to-member-Types" class="headerlink" title="pointer-to-member Types"></a>pointer-to-member Types</h3><p>A word about the types: , , and are different types. But are there conversions? The C++ standard provides a conversion from a pointer-to-member of a base class to a pointer-to-member of a derived class. That makes sense: You can apply an offset to a member of a base class to the base address of a derived object as well, as the base is a part of the derived object<a target="_blank" rel="noopener" href="http://www.vollmann.com/en/pubs/meta/meta/meta.html#fn7">7</a>. So you can assign<br>as the is part of each instance.<br>The other way around it obviously doesn’t work, you couldn’t initialize<br>as is not a member of each instance of type .<br>But the standard does not provide a conversion from to , though it would be save: If the result type of the pointer-to-member selector is a reference to a derived class, it can be safely converted to a reference of a respective base class, so it would also be safe to let the compiler do the conversion automatically and therefore also convert the pointer-to-members themselves. As already mentioned, the standard doesn’t provide (implicit) and even doesn’t allow (explicit through ) that conversion, probably because the committee didn’t see any use for pointer-to-data-members at all (see [<a target="_blank" rel="noopener" href="http://www.vollmann.com/en/pubs/meta/meta/meta.html#bk5">5</a>]), and for pointer-to-member-functions that conversion really doesn’t make sense.<br>The problem for us is: we need that conversion. We want to keep pointer-to-members to all members of a class in one common container, but what could be the type of that container’s elements? One option would be to force the conversion through a , but the only thing you can safely do with a ed thing is to it back, and for that you have to store the original type as well. So we use another option: we just define the conversion! But as C++ doesn’t allow you to define your own conversions to compiler-provided types (and in this sense the pointer-to-members are compiler defined, though the involved single types like or are user-defined), we have to define wrapper classes around them.<br>Here’s the implementation:<br>Some notes to the code: is used for the class to which a pointer to member is applied (e.g. ), is the result type to which a pointer-to-member points (), and is the base class of (). is the common base class as we need it (e.g. , which stands for ), hold an actual C++ pointer-to-member (), and is a handle class around to store them in a container. Here, the actual access function is the member function. If you want, you can add a global operator ‘’ (as template function), but you can’t provide the operator by a member function (as the left operand is not the class instance), and you can’t overload ‘’ (this is one of the few non-overloadable operators).<br>The constructor is a member template with two template parameters: a and the . The second one is clear as it defines the actual to be constructed, but the is not so obvious. If we omit the , so only having<br>and then we try to create a<br>some compilers give an error, as they cannot fiddle out the correct conversion. This would be to convert to , which should be done automatically, and then to instantiate ‘s constructor with as .<br>One way to solve this is to explicitly cast the pointer-to-member: but that’s quite a lot to type. It’s actually much easier to move that explicit conversion into the constructor itself and just provide an additional template parameter, as shown in the implementation above. The compiler checks the conversion anyway, so you will get a compile time error if that conversion is not allowed (e.g. if you try to convert a to .<code>RealValue Book::*``RealValue Product::*``BaseValue Product::*``bookDoubleMemPtr = &amp;Product::price;``price``Book``RealValue Product::* &amp;Book::author;``author``Product``RealValue Book::*``BaseValue Book::*``static_cast``reinterpret_cast``reinterpret_cast``reinterpret_cast``Book``BaseValue</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> BaseType, <span class="keyword">typename</span> BaseTargetType&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">MemPtrBase</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> BaseTargetType &amp; <span class="title">value</span><span class="params">(BaseType &amp; obj)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> BaseTargetType <span class="type">const</span> &amp; <span class="title">value</span><span class="params">(BaseType <span class="type">const</span> &amp; obj)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">        <span class="built_in">MemPtrBase</span>() &#123;&#125;</span><br><span class="line">        <span class="keyword">virtual</span> ~<span class="built_in">MemPtrBase</span>() &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="built_in">MemPtrBase</span>(MemPtrBase <span class="type">const</span> &amp;);</span><br><span class="line">        MemPtrBase &amp; <span class="keyword">operator</span>=(MemPtrBase <span class="type">const</span> &amp;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> BaseType, <span class="keyword">typename</span> BaseTargetType, <span class="keyword">typename</span> TargetType&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">TypedMemPtr</span> : <span class="keyword">public</span> MemPtrBase&lt;BaseType, BaseTargetType&gt;</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">TypedMemPtr</span>(TargetType BaseType::* ptr)</span><br><span class="line">         : <span class="built_in">p</span>(ptr)</span><br><span class="line">        &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">BaseTargetType &amp; <span class="title">value</span><span class="params">(BaseType &amp; obj)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> obj.*p;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">BaseTargetType <span class="type">const</span> &amp; <span class="title">value</span><span class="params">(BaseType <span class="type">const</span> &amp; obj)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> obj.*p;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        TargetType BaseType::* p;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> BaseType, <span class="keyword">typename</span> BaseTargetType&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">MemPtr</span> <span class="comment">// this is a handle only</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> BaseType2, <span class="keyword">typename</span> TargetType&gt;</span><br><span class="line">        <span class="function"><span class="keyword">explicit</span> <span class="title">MemPtr</span><span class="params">(TargetType BaseType2::* ptr)</span></span></span><br><span class="line"><span class="function">         : p(new TypedMemPtr&lt;BaseType, BaseTargetType,</span></span><br><span class="line"><span class="function">            TargetType&gt;(static_cast&lt;TargetType BaseType::*&gt;(ptr)))</span></span><br><span class="line"><span class="function">        &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">        ~<span class="built_in">MemPtr</span>()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">delete</span> p;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">BaseTargetType &amp; <span class="title">value</span><span class="params">(BaseType &amp; obj)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> p-&gt;<span class="built_in">value</span>(obj);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">BaseTargetType <span class="type">const</span> &amp; <span class="title">value</span><span class="params">(BaseType <span class="type">const</span> &amp; obj)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> p-&gt;<span class="built_in">value</span>(obj);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        MemPtrBase&lt;BaseType, BaseTargetType&gt; * p;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">BaseType``Book``TargetType``RealValue``BaseTargetType``TargetType``BaseValue``MemPtrBase&lt;&gt;``MemPtrBase``BaseValue Book::*``TypedMemPtr&lt;&gt;``TypedMemPtr &gt;``MemPtr&lt;&gt;``MemPtrBase&lt;&gt;``<span class="built_in">value</span>()``-&gt;*``.*``MemPtr``BaseType2``TargetType``TypedMemPtr``BaseType2``BaseType2</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> BaseType, <span class="keyword">typename</span> BaseTargetType&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">MemPtr</span> <span class="comment">// this is a handle only</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> TargetType&gt;</span><br><span class="line">        <span class="function"><span class="keyword">explicit</span> <span class="title">MemPtr</span><span class="params">(TargetType BaseType::* ptr)</span></span></span><br><span class="line"><span class="function">         : p(new TypedMemPtr&lt;BaseType, BaseTargetType, TargetType&gt;(ptr))</span></span><br><span class="line"><span class="function">        &#123;</span>&#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function">MemPtr&lt;Book, BaseValue&gt; <span class="title">mp2</span><span class="params">(&amp;Product::price)</span></span>;</span><br><span class="line">    </span><br><span class="line">RealValue Product::*``RealValue Book::*``MemPtr``RealValue``<span class="function">TargetType</span></span><br><span class="line"><span class="function">    MemPtr&lt;Book, BaseValue&gt;</span></span><br><span class="line"><span class="function">        <span class="title">mp2</span><span class="params">(<span class="keyword">static_cast</span>&lt;RealValue&lt;<span class="type">double</span>&gt; Book::*&gt;(&amp;Product::price))</span></span>;</span><br><span class="line">    </span><br><span class="line">RealValue Book::*``RealValue Cd::*</span><br></pre></td></tr></table></figure>

<h3 id="C-类"><a href="#C-类" class="headerlink" title="C++类"></a>C++类</h3><p>s 允许您访问普通C++对象的属性值。这对MOP的一部分有所帮助。但是属性本身呢？编译器具有必要的知识，但不幸的是，没有标准方法可以在运行时访问这些知识。因此，我们必须提供它并为其定义一个接口。为了允许与我们现有的顺利集成，我们提供了一个迭代器作为接口。现在，我们手动提供有关属性的信息，但在下面的文章中，我们将探讨如何使用预处理器。<br>因此，对于我们的类，我们提供以下函数：<br>请注意和之间的区别：前者仅提供有关其自身属性的信息，而后者还提供对基类成员的访问。这种分离是有道理的：虽然在对象级别上所有数据成员都构建一个对象，但在类级别上，基类是一个不同的实体，也应该作为元对象协议的公共基类使用。但是这种分离会产生后果：我们不能从MOP类派生C++类（但这绝对不是真正的限制），并且C++基类也必须让MOP知道（但这无论如何都很有用）。<br>我们没有提供有关基类信息的函数，因为如上所述，in 也必须成为一个实例。基类C++对于我们的应用程序没有多大用处。<br>使用这些函数，我们可以从C++类构建一个;这很容易，我们甚至可以为此提供一个帮助程序函数：<br>现在，我们可以为它们构建我们的s并从中创建实例：<br>但是停止 - 虽然这有效，但这不是我们想要的：现在，实例不是真正的C++对象，而是MOP对象，所有访问仍然必须通过MOP。<code>MemPtr``ClassDef``Attribute``Book</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">class</span> <span class="title class_">Book</span> : <span class="keyword">public</span> <span class="title class_">Product</span></span><br><span class="line">    &#123;</span><br><span class="line">        typedef <span class="title class_">MemPtr</span>&lt;<span class="title class_">Book</span>, <span class="title class_">FinalValue</span>&gt; <span class="title class_">MemberPtr</span>;</span><br><span class="line">    <span class="attr">public</span>:</span><br><span class="line">        <span class="comment">// as before</span></span><br><span class="line">        <span class="keyword">static</span> size_t <span class="title function_">ownAttribCount</span>(<span class="params"></span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">static</span> <span class="title class_">Attribute</span> * <span class="title function_">ownAttribBegin</span>(<span class="params"></span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">static</span> <span class="title class_">Attribute</span> a[]</span><br><span class="line">                = &#123;<span class="title class_">Attribute</span>(<span class="string">&quot;Author&quot;</span>, <span class="title class_">Type</span>::stringT),</span><br><span class="line">                   <span class="title class_">Attribute</span>(<span class="string">&quot;Title&quot;</span>, <span class="title class_">Type</span>::stringT),</span><br><span class="line">                   <span class="title class_">Attribute</span>(<span class="string">&quot;Publisher&quot;</span>, <span class="title class_">Type</span>::stringT),</span><br><span class="line">                   <span class="title class_">Attribute</span>(<span class="string">&quot;Price&quot;</span>, <span class="title class_">Type</span>::doubleT),</span><br><span class="line">                   <span class="title class_">Attribute</span>(<span class="string">&quot;Weight&quot;</span>, <span class="title class_">Type</span>::doubleT)</span><br><span class="line">                  &#125;;</span><br><span class="line">            <span class="keyword">return</span> a;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">static</span> <span class="title class_">Attribute</span> * <span class="title function_">ownAttribEnd</span>(<span class="params"></span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">ownAttribBegin</span>() + <span class="title function_">ownAttribCount</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">static</span> <span class="title class_">MemberPtr</span> * <span class="title function_">memberBegin</span>(<span class="params"></span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">static</span> <span class="title class_">MemberPtr</span> m[]</span><br><span class="line">                = &#123;<span class="title class_">MemberPtr</span>(&amp;<span class="title class_">Book</span>::productNo),</span><br><span class="line">                   <span class="title class_">MemberPtr</span>(&amp;<span class="title class_">Product</span>::weight),</span><br><span class="line">                   <span class="title class_">MemberPtr</span>(&amp;<span class="title class_">Book</span>::author),</span><br><span class="line">                   <span class="title class_">MemberPtr</span>(&amp;<span class="title class_">Book</span>::title),</span><br><span class="line">                   <span class="title class_">MemberPtr</span>(&amp;<span class="title class_">Book</span>::publisher),</span><br><span class="line">                   <span class="title class_">MemberPtr</span>(&amp;<span class="title class_">Book</span>::price),</span><br><span class="line">                   <span class="title class_">MemberPtr</span>(&amp;<span class="title class_">Book</span>::weight)</span><br><span class="line">                  &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> m;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">static</span> <span class="title class_">MemberPtr</span> * <span class="title function_">memberEnd</span>(<span class="params"></span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">memberBegin</span>() + <span class="number">7</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attr">private</span>:</span><br><span class="line">        <span class="title class_">RealValue</span>&lt;<span class="built_in">string</span>&gt; author, title, publisher;</span><br><span class="line">        <span class="title class_">RealValue</span>&lt;double&gt; price, weight;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line"><span class="title function_">ownAttribBegin</span>()<span class="string">``</span><span class="title function_">memberBegin</span>()<span class="string">``</span>baseClass<span class="string">``</span><span class="title class_">ClassDef</span><span class="string">``</span><span class="title class_">ClassDef</span><span class="string">``</span><span class="title class_">ClassDef</span></span><br><span class="line">    template &lt;typename <span class="title class_">CppClass</span>&gt;</span><br><span class="line">    <span class="title class_">ClassDef</span> <span class="title function_">makeClass</span>(<span class="params">ClassDef <span class="keyword">const</span> * base, <span class="built_in">string</span> <span class="keyword">const</span> &amp; name</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">ClassDef</span>(base, name,</span><br><span class="line">                        <span class="title class_">CppClass</span>::<span class="title function_">ownAttribBegin</span>(), <span class="title class_">CppClass</span>::<span class="title function_">ownAttribEnd</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="title class_">ClassDef</span><span class="string">``</span><span class="title class_">Product</span><span class="string">``</span><span class="title class_">Book</span></span><br><span class="line">    <span class="title class_">ClassDef</span> <span class="title function_">base</span>(makeClass&lt;<span class="title class_">DynaProduct</span>&gt;(<span class="number">0</span>, <span class="string">&quot;Product&quot;</span>));</span><br><span class="line">    <span class="title class_">ClassDef</span> <span class="title function_">book</span>(makeClass&lt;<span class="title class_">Book</span>&gt;(base, <span class="string">&quot;Book&quot;</span>));</span><br><span class="line">    book.<span class="title function_">newObject</span>();</span><br><span class="line">    </span><br></pre></td></tr></table></figure>



<h3 id="C-对象"><a href="#C-对象" class="headerlink" title="C++对象"></a>C++对象</h3><p>我们想要的是真实C++对象，我们也可以通过MOP访问，即通过接口。OO的方法是从中派生我们的，但是尽管其他像Smalltalk这样的OO语言这样做，但我认为有一个更好，侵入性更小的选择：我们提供了一个适配器。<br>从 [<a target="_blank" rel="noopener" href="http://www.vollmann.com/en/pubs/meta/meta/meta.html#bk4">4</a>] 中，我们了解到适配器模式有两个选项：将适配器类设计为仅派生自并包含成员的转发包装类，或者使用多重继承并从 和 派生适配器。为简单起见，我们将使用第一个选项，但实际应用程序通常受益于第二种方法。因此，我们提供了一个包装类，该类派生自并保存原始C++对象。它通过我们的 s 实现 （ 和 ） 的接口：<br>OO 设计的一个有用规则说，只有叶类应该是具体的，所以让我们定义为抽象基类，并创建一个类似于我们前者的真实 MOP 类实例的新类（图 7）。<br><img src="/build-vnc/fig7.jpg" alt="Fig. 7: Object Hierarchy"><br>图 7：对象层次结构<br>如果我们现在执行 一个 ，我们仍然会出错：我们现在得到一个 ，但我们想要一个 。为了解决这个问题，我们必须为 提供一种创建正确类型对象的方法，最简单的方法是工厂方法：我们在 and 中提供一个静态创建函数，为 和 提供指向该函数的指针，将其存储在 并使用该函数：<br>创建函数和 ：<br>对 的更改 ：和对 的简单更改 ：<br>现在，一切正常。嗯，差不多。如果我们现在尝试用编译器创建一个 for，则会抱怨创建一个抽象类：给构造函数一个指向 的指针，这会创建一个实例作为 的一部分。这很容易修复：只需使用创建函数的空指针直接调用构造函数，从而禁止通过 MOP 创建 Product 实例。<code>Object``Product``Object``Object``Product``Object``Product``CppObject``Object``Object``getValue()``setValue()``MemPtr</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">    template &lt;typename <span class="title class_">OrigClass</span>&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">CppObject</span> : <span class="keyword">public</span> <span class="title class_">Object</span></span><br><span class="line">    &#123;</span><br><span class="line">        typedef <span class="title class_">MemPtr</span>&lt;<span class="title class_">OrigClass</span>, <span class="title class_">BaseValue</span>&gt; <span class="title class_">MemberPtr</span>;</span><br><span class="line">    <span class="attr">public</span>:</span><br><span class="line">        <span class="title class_">CppObject</span>(<span class="title class_">ClassDef</span> <span class="keyword">const</span> * myClass)</span><br><span class="line">         : <span class="title class_">Object</span>(myClass), <span class="title function_">myObject</span>(), <span class="title function_">members</span>(<span class="params">OrigClass::memberBegin()</span>)</span><br><span class="line">        &#123;&#125;</span><br><span class="line"></span><br><span class="line">        virtual <span class="title class_">Object</span> * <span class="title function_">clone</span>() <span class="keyword">const</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CppObject</span>(*<span class="variable language_">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        using <span class="title class_">Object</span>::getValue; <span class="comment">// importing getValue(name)</span></span><br><span class="line">        using <span class="title class_">Object</span>::setValue; <span class="comment">// importing setValue(name)</span></span><br><span class="line"></span><br><span class="line">        virtual <span class="title class_">Value</span> <span class="title function_">getValue</span>(size_t idx) <span class="keyword">const</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> members[idx].<span class="title function_">value</span>(myObject);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        virtual <span class="built_in">void</span> <span class="title function_">setValue</span>(<span class="params">size_t idx, Value <span class="keyword">const</span> &amp; v</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="title class_">BaseValue</span> * p = &amp;(members[idx].<span class="title function_">value</span>(myObject));</span><br><span class="line">            p-&gt;<span class="title function_">set</span>(v);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attr">private</span>:</span><br><span class="line">        <span class="title class_">MemberPtr</span> * members;</span><br><span class="line">        <span class="title class_">OrigClass</span> myObject;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line"><span class="title class_">Object</span><span class="string">``</span><span class="title class_">DynaObject</span><span class="string">``</span><span class="title class_">Object</span><span class="string">``</span>prod.<span class="title function_">newObject</span>()<span class="string">``</span><span class="title class_">DynaObject</span><span class="string">``</span><span class="title class_">CppObject</span><span class="string">``</span><span class="title class_">ClassDef</span><span class="string">``</span><span class="title class_">CppObject</span>&lt;&gt;<span class="string">``</span><span class="title class_">DynaObject</span><span class="string">``</span><span class="title class_">ClassDef</span><span class="string">``</span><span class="title class_">ClassDef</span>::<span class="title function_">newObject</span>()<span class="string">``</span><span class="title class_">DynaObject</span><span class="string">``</span><span class="title class_">CppObject</span></span><br><span class="line">    <span class="title class_">Object</span> *</span><br><span class="line">    <span class="title class_">DynaObject</span>::<span class="title function_">newObject</span>(<span class="params">ClassDef <span class="keyword">const</span> * myClass</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DynaObject</span>(myClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    template &lt;typename <span class="title class_">OrigClass</span>&gt;</span><br><span class="line">    <span class="title class_">Object</span> *</span><br><span class="line">    <span class="title class_">CppObject</span>&lt;<span class="title class_">OrigClass</span>&gt;::<span class="title function_">newObject</span>(<span class="params">ClassDef <span class="keyword">const</span> * myClass</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CppObject</span>(myClass);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="title class_">ClassDef</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">ClassDef</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="attr">public</span>:</span><br><span class="line">        typedef <span class="title class_">Object</span> * (*<span class="title class_">CreateObjFunc</span>)(<span class="title class_">ClassDef</span> <span class="keyword">const</span> *);</span><br><span class="line"></span><br><span class="line">        template &lt;typename <span class="title class_">Iterator</span>&gt;</span><br><span class="line">        <span class="title class_">ClassDef</span>(<span class="title class_">ClassDef</span> <span class="keyword">const</span> *, <span class="built_in">string</span> <span class="keyword">const</span> &amp;,</span><br><span class="line">                 <span class="title class_">CreateObjFunc</span> objFunc,</span><br><span class="line">                 <span class="title class_">Iterator</span>, <span class="title class_">Iterator</span>)</span><br><span class="line">         : <span class="comment">// ...</span></span><br><span class="line">           <span class="title function_">createObj</span>(<span class="params">objFunc</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">ClassDef</span>(<span class="title class_">ClassDef</span> <span class="keyword">const</span> *, <span class="built_in">string</span> &amp; <span class="keyword">const</span> name_,</span><br><span class="line">                 <span class="title class_">CreateObjFunc</span> objFunc)</span><br><span class="line">         : <span class="comment">// ...</span></span><br><span class="line">           <span class="title function_">createObj</span>(<span class="params">objFunc</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Object</span> * <span class="title function_">newObject</span>() <span class="keyword">const</span></span><br><span class="line">        &#123;</span><br><span class="line">            definitionFix = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span> (*createObj)(<span class="variable language_">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ... as before</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">private</span>:</span><br><span class="line">        <span class="keyword">const</span> <span class="title class_">CreateObjFunc</span> createObj;</span><br><span class="line">        <span class="comment">// ... as before</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">makeClass</span><br><span class="line">    template &lt;typename <span class="title class_">CppClass</span>&gt;</span><br><span class="line">    <span class="title class_">ClassDef</span> <span class="title function_">makeClass</span>(<span class="params">ClassDef <span class="keyword">const</span> * base, <span class="built_in">string</span> <span class="keyword">const</span> &amp; name</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">ClassDef</span>(base, name,</span><br><span class="line">                        <span class="title class_">CppObject</span>&lt;<span class="title class_">CppClass</span>&gt;::newObject,</span><br><span class="line">                        <span class="title class_">CppClass</span>::<span class="title function_">ownAttribBegin</span>(),</span><br><span class="line">                        <span class="title class_">CppClass</span>::<span class="title function_">ownAttribEnd</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="title class_">ClassDef</span><span class="string">``</span><span class="title class_">Product</span><span class="string">``</span>makeClass<span class="string">``</span>makeClass<span class="string">``</span><span class="title class_">ClassDef</span><span class="string">``</span><span class="title class_">CppObject</span>::<span class="title function_">newObject</span>()<span class="string">``</span><span class="title class_">Product</span><span class="string">``</span><span class="title class_">CppObject</span><span class="string">``</span><span class="title class_">ClassDef</span></span><br></pre></td></tr></table></figure>

<h3 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h3><p>MOP，就像你现在拥有的那样，允许你像以前一样将C++类定义为MOP类：<br>你可以创建它们的</p>
<p>实例 你可以定义派生自<br>现有类和新类的新类，并通过MOP操作现有类和新类的实例：<br>C++对象：<br>和动态对象：</p>
<figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">    ClassDef base(<span class="number">0</span>, <span class="string">&quot;Product&quot;</span>, <span class="number">0</span>,</span><br><span class="line">                  Product::ownAttribBegin(),</span><br><span class="line">                  Product::ownAttribEnd());</span><br><span class="line">    ClassDef book(makeClass&lt;Book&gt;(&amp;base, <span class="string">&quot;Book&quot;</span>));</span><br><span class="line">    </span><br><span class="line">book.newObject();``Product</span><br><span class="line">    ClassDef * tShirt</span><br><span class="line">        = <span class="keyword">new</span> ClassDef(&amp;base, <span class="string">&quot;T-Shirt&quot;</span>,</span><br><span class="line">              DynaObject::newObject);</span><br><span class="line"></span><br><span class="line">    tShirt-&gt;addAttribute(Attribute(<span class="string">&quot;Size&quot;</span>, Type::stringT));</span><br><span class="line">    tShirt-&gt;addAttribute(Attribute(<span class="string">&quot;Color&quot;</span>, Type::stringT));</span><br><span class="line">    tShirt-&gt;addAttribute(Attribute(<span class="string">&quot;Name&quot;</span>, Type::stringT));</span><br><span class="line">    tShirt-&gt;addAttribute(Attribute(<span class="string">&quot;Price&quot;</span>, Type::doubleT));</span><br><span class="line"></span><br><span class="line">    classReg.registerClass(tShirt);</span><br><span class="line">    </span><br><span class="line">    Object * ecpp(book.newObject());</span><br><span class="line"></span><br><span class="line">    ecpp-&gt;setValue(<span class="number">5</span>, RealValue&lt;<span class="keyword">double</span>&gt;(<span class="number">22.50</span>));</span><br><span class="line">    ecpp-&gt;setValue(<span class="number">0</span>, RealValue&lt;<span class="keyword">int</span>&gt;(<span class="number">23456</span>));</span><br><span class="line">    ecpp-&gt;setValue(<span class="number">2</span>, RealValue&lt;<span class="keyword">string</span>&gt;(<span class="string">&quot;Scott Meyers&quot;</span>));</span><br><span class="line">    ecpp-&gt;setValue(<span class="string">&quot;Title&quot;</span>, RealValue&lt;<span class="keyword">string</span>&gt;(<span class="string">&quot;Effective C++&quot;</span>));</span><br><span class="line">    ecpp-&gt;setValue(<span class="number">6</span>, RealValue&lt;<span class="keyword">double</span>&gt;(<span class="number">280</span>));</span><br><span class="line">    size_t idx;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;ecpp:&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">for</span> (a = book.attribBegin(), idx = <span class="number">0</span>;</span><br><span class="line">         a != book.attribEnd();</span><br><span class="line">         ++a, ++idx)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; a-&gt;getName() &lt;&lt; <span class="string">&quot;: &quot;</span></span><br><span class="line">             &lt;&lt; ecpp-&gt;getValue(idx).asString() &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; ecpp-&gt;getValue(<span class="string">&quot;Author&quot;</span>).asString() &lt;&lt; endl;</span><br><span class="line">    </span><br><span class="line">    Object * ts(tShirt.newObject());</span><br><span class="line">    ts-&gt;setValue(<span class="number">0</span>, RealValue&lt;<span class="keyword">int</span>&gt;(<span class="number">87654</span>));</span><br><span class="line">    ts-&gt;setValue(<span class="number">2</span>, RealValue&lt;<span class="keyword">string</span>&gt;(<span class="string">&quot;XXL&quot;</span>));</span><br><span class="line">    ts-&gt;setValue(<span class="string">&quot;Color&quot;</span>, RealValue&lt;<span class="keyword">string</span>&gt;(<span class="string">&quot;red&quot;</span>));</span><br><span class="line">    ts-&gt;setValue(<span class="string">&quot;Price&quot;</span>, RealValue&lt;<span class="keyword">double</span>&gt;(<span class="number">25.95</span>));</span><br><span class="line">    ts-&gt;setValue(<span class="string">&quot;Weight&quot;</span>, RealValue&lt;<span class="keyword">double</span>&gt;(<span class="number">387</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (size_t idx = <span class="number">0</span>; idx != <span class="number">4</span>; ++idx)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; ts-&gt;getValue(idx).asString() &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<h3 id="C-接口"><a href="#C-接口" class="headerlink" title="C++接口"></a>C++接口</h3><p>您无法通过接口访问 MOP 创建的实例。对于C++类的实例，您可以修改 要派生自，如前所述，或者更好的是，提供一个成员函数，该函数返回指向 的指针。对于MOP类的实例，您可以在实现接口的周围定义一个包装器：<br>并且您无法通过MOP访问正常的C++实例;为了解决这个问题，你可以添加另一个通过复制来采用C++实例的构造函数（因此你应该删除原始构造函数以避免存在两次的对象），或者你可以修改包装器以仅保存指向C++对象的指针，并添加一个成员函数以根据请求返回受控C++对象： 在这里，我们使用第一种方法：<br>现在，您可以执行此操作：<br>但通常，重要的是您可以在编程时C++定义基本类，但允许用户在运行时从这些基类派生自己的类。<code>Product``CppObject``T``CppObject``myObject``Object``Product</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">class</span> <span class="title class_">DynaProduct</span> : <span class="keyword">public</span> Product</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">DynaProduct</span>(Object <span class="type">const</span> * o) : <span class="built_in">obj</span>(o) &#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> std::string <span class="title">getName</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            Value v = obj-&gt;<span class="built_in">getValue</span>(<span class="string">&quot;Name&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> v.<span class="built_in">get</span>&lt;std::string&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="type">double</span> <span class="title">getPrice</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            Value v = obj-&gt;<span class="built_in">getValue</span>(<span class="string">&quot;Price&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> v.<span class="built_in">get</span>&lt;<span class="type">double</span>&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="type">double</span> <span class="title">getWeight</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            Value v = obj-&gt;<span class="built_in">getValue</span>(<span class="string">&quot;Weight&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> v.<span class="built_in">get</span>&lt;<span class="type">double</span>&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        Object <span class="type">const</span> * <span class="type">const</span> obj;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">Book</span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> OrigClass&gt;</span><br><span class="line">        CppObject&lt;OrigClass&gt;::<span class="built_in">CppObject</span>(ClassDef <span class="type">const</span> * myClass,</span><br><span class="line">                                        OrigClass <span class="type">const</span> &amp; obj)</span><br><span class="line">         : <span class="built_in">Object</span>(myClass),</span><br><span class="line">           <span class="built_in">myObject</span>(obj), <span class="comment">// calls the copy-ctor of OrigClass,</span></span><br><span class="line">                             <span class="function">which must be accessible</span></span><br><span class="line"><span class="function">           <span class="title">members</span><span class="params">(OrigClass::memberBegin())</span></span></span><br><span class="line"><span class="function">        </span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function">Book <span class="title">b</span><span class="params">(<span class="string">&quot;Bjarne Stroustrup&quot;</span>, <span class="string">&quot;The C++ Programming Language&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">           <span class="string">&quot;Addison-Wesley&quot;</span>, <span class="number">27.50</span>, <span class="number">370</span>)</span></span>;</span><br><span class="line">    <span class="function">CppObject&lt;Book&gt; <span class="title">mb</span><span class="params">(*book, b)</span></span>;</span><br><span class="line">    Object * ob = &amp;mb;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;C++ object through MOP&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">for</span> (a = ob-&gt;<span class="built_in">instanceOf</span>()-&gt;<span class="built_in">attribBegin</span>(), idx = <span class="number">0</span>;</span><br><span class="line">         a != ob-&gt;<span class="built_in">instanceOf</span>()-&gt;<span class="built_in">attribEnd</span>();</span><br><span class="line">         ++a, ++idx)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; a-&gt;<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot;: &quot;</span></span><br><span class="line">             &lt;&lt; ob-&gt;<span class="built_in">getValue</span>(idx).<span class="built_in">asString</span>() &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Jok Brown
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://www.likepanda.cn/2022/03/25/build-vnc/" title="">http://www.likepanda.cn/2022/03/25/build-vnc/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/03/25/bochs/" rel="prev" title="bochs">
                  <i class="fa fa-chevron-left"></i> bochs
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/03/18/codeedit/" rel="next" title="使用QT编写的代码编辑器">
                  使用QT编写的代码编辑器 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2021 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jok Brown</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>

  <script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdn.jsdelivr.net/npm/pdfobject@2.2.7/pdfobject.min.js","integrity":"sha256-ph3Dk89VmuTVXG6x/RDzk53SU9LPdAh1tpv0UvnDZ2I="},"url":"/lib/pdf/web/viewer.html"}</script>
  <script src="/js/third-party/tags/pdf.js"></script>



  <script src="/js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
